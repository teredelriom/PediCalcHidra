<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Calculadora Hidrataci√≥n Pedi√°trica</title>
  <link rel="manifest" href="manifest.json" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@heroicons/react/solid/esm/index.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <style>
    :root {
      --color-principal: #037F8C;
      --color-secundario: #36B1BF;
      --color-acento: #F272A1;
      --color-claro: #82D0D9;
    }
    .switch {
      appearance: none;
      width: 2.5rem;
      height: 1.4rem;
      background: #ccc;
      border-radius: 9999px;
      position: relative;
      outline: none;
      cursor: pointer;
      transition: background 0.3s;
    }
    .switch:checked {
      background: var(--color-principal);
    }
    .switch::before {
      content: "";
      position: absolute;
      top: 0.2rem;
      left: 0.2rem;
      width: 1rem;
      height: 1rem;
      background: white;
      border-radius: 50%;
      transition: transform 0.3s;
    }
    .switch:checked::before {
      transform: translateX(1.1rem);
    }
    #peso:invalid {
      border: 2px solid red;
    }
    #peso:valid {
      border: 2px solid green;
    }
    @media print {
      body * {
        visibility: hidden;
      }
      #resultado, #resultado * {
        visibility: visible;
      }
      #resultado {
        position: absolute;
        left: 0;
        top: 0;
        width: 100%;
        font-family: Arial, sans-serif;
        padding: 2rem;
        background-color: #fff;
        color: #000;
      }
    }
  </style>
</head>
<body class="bg-[#EAF8F9] min-h-screen flex flex-col items-center p-4">
  <div class="bg-white shadow-xl rounded-2xl p-6 w-full max-w-md">
    <h2 class="text-2xl font-semibold text-[#037F8C] text-center mb-4">Calculadora de Hidrataci√≥n Pedi√°trica</h2>

    <!-- Campo de entrada para el peso en gramos -->
    <div class="mb-4">
      <label for="peso" class="block text-sm font-medium text-gray-700">Peso en gramos</label>
      <input type="number" id="peso" class="mt-1 block w-full p-2 border rounded-md" placeholder="Ej: 8500" required />
    </div>

    <!-- Grado de deshidrataci√≥n -->
    <div class="mb-4">
      <label for="deshidratacion" class="block text-sm font-medium text-gray-700">Grado de deshidrataci√≥n</label>
      <select id="deshidratacion" class="mt-1 block w-full p-2 border rounded-md">
        <option value="0">Sin deshidrataci√≥n</option>
        <option value="50">Leve (3-5%)</option>
        <option value="75">Moderada (6-9%)</option>
        <option value="100">Severa (>10%)</option>
      </select>
    </div>
 <!-- Condiciones cl√≠nicas -->
    <div class="mb-4">
      <label for="condiciones" class="block text-sm font-medium text-gray-700">Condiciones cl√≠nicas (selecci√≥n m√∫ltiple)</label>
      <div class="space-y-2">
        <label class="flex items-center">
          <input type="checkbox" value="fiebre" class="mr-2" onchange="toggleTemperaturas()" /> Fiebre (>37.5¬∞C)
        </label>
        <label class="flex items-center">
          <input type="checkbox" value="ambienteCalido" class="mr-2" onchange="toggleTemperaturas()" /> Ambiente caluroso (>31¬∞C)
        </label>
        <label class="flex items-center">
          <input type="checkbox" value="vm" class="mr-2" /> Ventilaci√≥n mec√°nica
        </label>
        <label class="flex items-center">
          <input type="checkbox" value="hipernatremia" class="mr-2" /> Hipernatremia
        </label>
        <label class="flex items-center">
          <input type="checkbox" value="edema" class="mr-2" /> Edema
        </label>
        <label class="flex items-center">
          <input type="checkbox" value="oliguria" class="mr-2" /> Oliguria o IRA
        </label>
        <label class="flex items-center">
          <input type="checkbox" value="postq" class="mr-2" /> Postquir√∫rgico / Cr√≠tico
        </label>
      </div>
    </div>

    <!-- Temperatura corporal y ambiental -->
    <div id="tempFiebre" class="hidden mb-4">
      <label for="tempF" class="block text-sm font-medium text-gray-700">Temperatura corporal (¬∞C)</label>
      <input type="number" id="tempF" class="mt-1 block w-full p-2 border rounded-md" placeholder="Ej: 38.5" />
    </div>
    <div id="tempAmbiente" class="hidden mb-4">
      <label for="tempA" class="block text-sm font-medium text-gray-700">Temperatura ambiental (¬∞C)</label>
      <input type="number" id="tempA" class="mt-1 block w-full p-2 border rounded-md" placeholder="Ej: 33" />
    </div>

    <!-- Botones de acci√≥n -->
    <div class="mt-4">
      <button onclick="calcular()" class="w-full bg-[#037F8C] text-white p-2 rounded-md">
        <i class="h-5 w-5 mr-2 text-white"></i> Calcular
      </button>
    </div>
  </div>

  <!-- Resultado de la calculadora -->
  <div class="resultado mt-6 bg-white shadow-lg rounded-xl p-4 w-full max-w-xl" id="resultado"></div>

  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/service-worker.js').then(registration => {
          console.log('Service Worker registrado con √©xito:', registration);
        }).catch(error => {
          console.log('Error al registrar el Service Worker:', error);
        });
      });
    }

    let textoCopia = "";
 function toggleTemperaturas() {
      const checkboxes = document.querySelectorAll('#condiciones input[type=checkbox]');
      let condiciones = Array.from(checkboxes).filter(c => c.checked).map(c => c.value);
      document.getElementById("tempFiebre").classList.toggle("hidden", !condiciones.includes("fiebre"));
      document.getElementById("tempAmbiente").classList.toggle("hidden", !condiciones.includes("ambienteCalido"));
    }

    function calcular() {
      const peso = parseFloat(document.getElementById("peso").value) / 1000;
      if (!peso || peso <= 0) {
        alert("Por favor, ingresa un peso v√°lido mayor a 0.");
        return;
      }

      const deficitPct = parseFloat(document.getElementById("deshidratacion")?.value || 0);
      const checkboxes = document.querySelectorAll('#condiciones input[type=checkbox]');
      let condiciones = Array.from(checkboxes).filter(c => c.checked).map(c => c.value);
      const tempF = parseFloat(document.getElementById("tempF")?.value) || 37.5;
      const tempA = parseFloat(document.getElementById("tempA")?.value) || 31;

      let mantenimiento = 0;
      if (peso <= 10) mantenimiento = peso * 100;
      else if (peso <= 20) mantenimiento = 1000 + (peso - 10) * 50;
      else mantenimiento = 1500 + (peso - 20) * 20;

      let factorMod = 1.0;
      if (condiciones.includes("fiebre") && tempF > 37.5) factorMod += 0.12 * (tempF - 37.5);
      if (condiciones.includes("ambienteCalido") && tempA > 31) mantenimiento += Math.floor(mantenimiento / 100) * (tempA - 31) * 30;

      let condicionesReductoras = ["vm", "hipernatremia", "edema", "oliguria", "postq"];
      let countReductoras = condiciones.filter(c => condicionesReductoras.includes(c)).length;
      if (countReductoras >= 2) {
        alert("‚ö†Ô∏è Precauci√≥n: m√∫ltiples condiciones que reducen volumen pueden subestimar el requerimiento total.");
      }

      if (condiciones.includes("vm")) mantenimiento *= 0.8;
      if (condiciones.includes("hipernatremia")) mantenimiento *= 0.75;
      if (condiciones.includes("edema")) mantenimiento *= 0.75;
      if (condiciones.includes("oliguria")) mantenimiento *= 0.5;
      if (condiciones.includes("postq")) mantenimiento *= 0.75;

      mantenimiento *= factorMod;
      const deficit = peso * deficitPct;
      const total24h = mantenimiento + deficit;
      const mantenimientoHora = mantenimiento / 24;

      const calorias = mantenimiento;
      const glucosa = calorias * 0.05;
      const sodio = calorias * 0.03;
      const potasio = calorias * 0.02;

      const porcM = (mantenimiento / total24h) * 100;
      const porcD = (deficit / total24h) * 100;

      let solucion = "DAD 5% + NaCl 0.45% + KCl 20 mEq/L";
      if (deficitPct >= 75) solucion = "Iniciar con SF 0.9% en bolos (20 ml/kg), luego DAD 5% + NaCl 0.45% + KCl";

      const volumenSG = 500;
      const volumenNaCl = Math.round(sodio / 1.7);
      const volumenKCl = Math.round(potasio / 1.34);

      const bolo = peso * 20;
      const textoIndicacion = `Indicaci√≥n EV 24h:
- Mantenimiento: ${mantenimiento.toFixed(0)} ml (${porcM.toFixed(1)}%)
- D√©ficit: ${deficit.toFixed(0)} ml (${porcD.toFixed(1)}%)
- Total: ${total24h.toFixed(0)} ml
- Volumen horario: ${mantenimientoHora.toFixed(0)} ml/h

F√≥rmula:
SG 5% ${volumenSG}cc + NaCl 10% ${volumenNaCl}cc + KCl 10% ${volumenKCl}cc
(Equivale a: Na ~35 mEq/L, K ~10 mEq/L)

Requerimientos:
- Calor√≠as: ${calorias.toFixed(0)} kcal
- Glucosa: ${glucosa.toFixed(1)} g
- Sodio: ${sodio.toFixed(1)} mEq
- Potasio: ${potasio.toFixed(1)} mEq

${deficitPct >= 75 ? `Bolo inicial: SF 0.9% ${bolo.toFixed(0)} ml (20 cc/kg)` : ""}`;

      textoCopia = textoIndicacion.trim();
      document.getElementById("resultado").innerHTML = `<pre class="whitespace-pre-wrap text-gray-800">${textoCopia}</pre>`;
    }

    function copiarTexto() {
      if (!textoCopia) {
        alert("Primero debes calcular los valores.");
        return;
      }
      navigator.clipboard.writeText(textoCopia).then(() => {
        alert("üìã Indicaci√≥n copiada al portapapeles.");
      }, () => {
        alert("‚ùå Error al copiar. Intenta nuevamente.");
      });
    }

    function exportarPDF() {
      const resultado = document.getElementById("resultado");
      const ventana = window.open('', '', 'height=700,width=700');
      ventana.document.write('<html><head><title>Indicacion Hidrataci√≥n</title>');
      ventana.document.write('<style>body{font-family:Arial,sans-serif;padding:2rem;color:#000;background:#fff;}</style>');
      ventana.document.write('</head><body><pre>' + resultado.innerText + '</pre></body></html>');
      ventana.document.close();
      ventana.print();
    }

    function exportarImagen() {
      const resultado = document.getElementById("resultado");
      html2canvas(resultado).then(canvas => {
        const enlace = document.createElement("a");
        enlace.download = "indicacion_hidratacion.png";
        enlace.href = canvas.toDataURL();
        enlace.click();
      }

    // Funci√≥n para manejar el c√°lculo y almacenamiento
    function calcular() {
      const peso = parseFloat(document.getElementById("peso").value) / 1000;
      if (!peso || peso <= 0) {
        alert("Por favor, ingresa un peso v√°lido mayor a 0.");
        return;
      }

      const deficitPct = parseFloat(document.getElementById("deshidratacion")?.value || 0);
      const mantenimiento = peso * 100; // Simplificado para este ejemplo
      const deficit = peso * deficitPct;
      const total24h = mantenimiento + deficit;

      // Guardar en localStorage
      localStorage.setItem('resultado', JSON.stringify({
        mantenimiento: mantenimiento.toFixed(0),
        deficit: deficit.toFixed(0),
        total24h: total24h.toFixed(0)
      }));

      // Mostrar resultados en la interfaz
      const resultadoTexto = `Mantenimiento: ${mantenimiento.toFixed(0)} ml\nD√©ficit: ${deficit.toFixed(0)} ml\nTotal: ${total24h.toFixed(0)} ml`;
      textoCopia = resultadoTexto;
      document.getElementById("resultado").innerHTML = `<pre>${resultadoTexto}</pre>`;
    }

    // Recuperar resultados al cargar
    window.onload = () => {
      const storedResult = localStorage.getItem('resultado');
      if (storedResult) {
        const resultado = JSON.parse(storedResult);
        document.getElementById("resultado").innerHTML = `<pre>${JSON.stringify(resultado, null, 2)}</pre>`;
      }
    };
  </script>
</body>
</html>
