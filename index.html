<!DOCTYPE html>
<html lang="es">
<head>
  <link rel="manifest" href="manifest.json">
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('sw.js')
          .then(reg => console.log('SW registrado:', reg.scope))
          .catch(err => console.error('Fallo SW:', err));
      });
    }
  </script>

  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Calculadora de Hidratación Pediátrica</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="p-4 md:p-8">
  <h1 class="text-2xl font-bold mb-4">Calculadora de Hidratación Pediátrica</h1>

  <!-- Campos de entrada simulados -->
  <input id="peso" class="input-highlight border p-2" placeholder="Peso (g)" />
  <input id="edad" class="input-highlight border p-2" placeholder="Edad (años)" />
  <input id="tempF" class="input-highlight border p-2 hidden" placeholder="Temp Fiebre (°C)" />
  <input id="tempA" class="input-highlight border p-2 hidden" placeholder="Temp Ambiente (°C)" />
  <select id="deshidratacion" class="border p-2">
    <option value="0.05">5%</option>
    <option value="0.10">10%</option>
  </select>
  <div>
    <label><input type="checkbox" name="condicionClinica" value="hiponatremia"> Hiponatremia</label>
    <label><input type="checkbox" name="condicionClinica" value="hipernatremia"> Hipernatremia</label>
    <label><input type="checkbox" name="condicionClinica" value="edema"> Edema</label>
    <label><input type="checkbox" name="condicionClinica" value="oliguria"> Oliguria</label>
  </div>
  <button id="btnCalcular" onclick="calcular()" class="mt-4 bg-blue-500 text-white px-4 py-2">Calcular</button>

  <!-- Resultados -->
  <div id="resultado" class="hidden mt-4">
    <div id="mantenimientoResult"></div>
    <div id="deficitResult"></div>
    <div id="total24hResult"></div>
    <div id="flujoHorarioResult"></div>
    <div id="hollidaySegarResult"></div>
    <div id="notasClinicas"></div>
    <div id="solucionRecomendada"></div>
    <div id="solucionesAlternativas" class="hidden">
      <h3>💡 Soluciones Alternativas</h3>
      <div id="listaAlternativas"></div>
    </div>
  </div>

  <div id="estadoConexion" class="text-sm mt-2"></div>

  <script>
// JavaScript con funciones completas (versión corregida y extendida)
<!DOCTYPE html>
<html lang="es">
<head>
  <link rel="manifest" href="manifest.json">
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('sw.js')
          .then(reg => console.log('SW registrado:', reg.scope))
          .catch(err => console.error('Fallo SW:', err));
      });
    }
  </script>

  <!-- ... (previous head content remains the same) ... -->
</head>
<body class="p-4 md:p-8">
  <!-- ... (previous body content remains the same until the script section) ... -->

  <script>
    // Constants for validation
    const MAX_WEIGHT = 50000; // 50kg in grams
    const MAX_AGE = 18; // Maximum age in years
    const MIN_TEMP = 35;
    const MAX_TEMP = 42;
    const MIN_AMBIENT_TEMP = 20;
    const MAX_AMBIENT_TEMP = 50;

    // Register Service Worker with improved error handling
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', async () => {
        try {
          const registration = await navigator.serviceWorker.register('sw.js');
          console.log('ServiceWorker registration successful with scope: ', registration.scope);
          
          // Check for updates
          registration.addEventListener('updatefound', () => {
            const newWorker = registration.installing;
            newWorker.addEventListener('statechange', () => {
              if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                console.log('New content available; please refresh.');
              }
            });
          });
        } catch (err) {
          console.error('ServiceWorker registration failed: ', err);
        }
      });
    }

    // Improved input validation functions
    function validateWeight(weight) {
      if (!weight || isNaN(weight)) {
        return { valid: false, message: "Por favor ingrese un peso válido" };
      }
      if (weight < 100) {
        return { valid: false, message: "El peso mínimo es 100g" };
      }
      if (weight > MAX_WEIGHT) {
        return { valid: false, message: `El peso máximo es ${MAX_WEIGHT/1000}kg` };
      }
      return { valid: true };
    }

    function validateAge(age) {
      if (age && (isNaN(age) || age < 0)) {
        return { valid: false, message: "Por favor ingrese una edad válida" };
      }
      if (age > MAX_AGE) {
        return { valid: false, message: `La edad máxima es ${MAX_AGE} años` };
      }
      return { valid: true };
    }

    function validateTemperature(temp, isBodyTemp = true) {
      if (!temp || isNaN(temp)) return { valid: false };
      
      const min = isBodyTemp ? MIN_TEMP : MIN_AMBIENT_TEMP;
      const max = isBodyTemp ? MAX_TEMP : MAX_AMBIENT_TEMP;
      
      if (temp < min || temp > max) {
        return { 
          valid: false,
          message: `La temperatura debe estar entre ${min}°C y ${max}°C`
        };
      }
      return { valid: true };
    }

    // Improved error display function
    function showError(inputElement, message) {
      const errorElement = document.createElement('p');
      errorElement.className = 'text-red-500 text-xs mt-1';
      errorElement.id = `${inputElement.id}-error`;
      errorElement.textContent = message;
      
      // Remove existing error if present
      const existingError = document.getElementById(`${inputElement.id}-error`);
      if (existingError) existingError.remove();
      
      inputElement.classList.add('border-red-500');
      inputElement.parentNode.appendChild(errorElement);
    }

    function clearError(inputElement) {
      inputElement.classList.remove('border-red-500');
      const errorElement = document.getElementById(`${inputElement.id}-error`);
      if (errorElement) errorElement.remove();
    }

    // Enhanced calcular function with better validation
    function calcular() {
      // Clear previous errors
      document.querySelectorAll('.input-highlight').forEach(input => clearError(input));
      
      // Validate inputs
      const pesoInput = document.getElementById("peso");
      const peso = parseFloat(pesoInput.value);
      const pesoValidation = validateWeight(peso);
      if (!pesoValidation.valid) {
        showError(pesoInput, pesoValidation.message);
        return;
      }

      const edadInput = document.getElementById("edad");
      const edad = parseFloat(edadInput.value) || 0;
      const edadValidation = validateAge(edad);
      if (!edadValidation.valid) {
        showError(edadInput, edadValidation.message);
        return;
      }

      // Validate temperatures if visible
      if (!document.getElementById("tempFiebre").classList.contains("hidden")) {
        const tempF = parseFloat(document.getElementById("tempF").value);
        const tempFValidation = validateTemperature(tempF);
        if (!tempFValidation.valid) {
          showError(document.getElementById("tempF"), tempFValidation.message);
          return;
        }
      }

      if (!document.getElementById("tempAmbiente").classList.contains("hidden")) {
        const tempA = parseFloat(document.getElementById("tempA").value);
        const tempAValidation = validateTemperature(tempA, false);
        if (!tempAValidation.valid) {
          showError(document.getElementById("tempA"), tempAValidation.message);
          return;
        }
      }

      // Rest of the calculation logic remains the same...
      const pesoKg = peso / 1000;
      const deficitPct = parseFloat(document.getElementById("deshidratacion").value);
      
      let mantenimiento = calcularMantenimiento(pesoKg);
      const deficit = pesoKg * deficitPct;
      const total24h = mantenimiento + deficit;
      
      // Update UI with results
      document.getElementById("mantenimientoResult").textContent = Math.round(mantenimiento);
      document.getElementById("deficitResult").textContent = Math.round(deficit);
      document.getElementById("total24hResult").textContent = Math.round(total24h);
      document.getElementById("flujoHorarioResult").textContent = (total24h / 24).toFixed(1);
      
      // Calculate electrolytes with improved validation
      const calorias = mantenimiento;
      const glucosaReq = calorias * 0.05;
      let sodioReq = calorias * 0.03;
      let potasioReq = calorias * 0.025;
      
      // Adjust based on conditions
      const condiciones = obtenerCondicionesSeleccionadas();
      if (condiciones.includes("hipernatremia")) sodioReq *= 0.5;
      if (condiciones.includes("hiponatremia")) sodioReq *= 1.5;
      if (condiciones.includes("edema") || condiciones.includes("oliguria")) potasioReq *= 0.5;
      
      // Calculate recommended solution
      const { solucionOptima, solucionesAlternativas } = calcularSolucionRecomendada(
        mantenimiento, 
        sodioReq, 
        potasioReq, 
        glucosaReq,
        condiciones,
        edad
      );
      
      // Show results
      mostrarFormulaHollidaySegar(pesoKg, mantenimiento, sodioReq, potasioReq, glucosaReq);
      mostrarNotasClinicas(solucionOptima, condiciones, edad);
      
      if (solucionesAlternativas.length > 0) {
        mostrarSolucionesAlternativas(solucionesAlternativas, potasioReq);
        document.getElementById("solucionesAlternativas").classList.remove("hidden");
      }
      
      document.getElementById("resultado").classList.remove("hidden");
      
      // Improve accessibility for screen readers
      const resultadoSection = document.getElementById("resultado");
      resultadoSection.setAttribute("aria-live", "polite");
      resultadoSection.setAttribute("aria-atomic", "true");
    }

    // Enhanced solution calculation with better error handling
    function calcularSolucionRecomendada(mantenimiento, sodioReq, potasioReq, glucosaReq, condiciones, edad) {
      try {
        // Load solutions from a more maintainable structure
        const solucionesBase = [
          { 
            nombre: "SG 5% + NaCl 0.2%",
            descripcion: "Solución glucosada al 5% con NaCl 0.2%",
            sgPorcentaje: 5,
            naPorLitro: 34,
            glucosaPorLitro: 50,
            caloriasPorLitro: 200,
            tipo: "bajaNa"
          },
          // ... other solutions ...
        ];

        // Evaluate each solution with volume constraints
        const opciones = solucionesBase.map(sol => {
          const volumen = Math.min(mantenimiento, (glucosaReq * 1000) / sol.glucosaPorLitro);
          const sodioTotal = (sol.naPorLitro * volumen) / 1000;
          const diferenciaSodio = sodioTotal - sodioReq;
          
          return {
            ...sol,
            volumen: Math.round(volumen),
            sodioTotal: parseFloat(sodioTotal.toFixed(1)),
            diferenciaSodio: parseFloat(diferenciaSodio.toFixed(1)),
            adecuacion: Math.abs(diferenciaSodio)
          };
        });

        // Select best option based on conditions
        let mejorOpcion = opciones[0];
        let solucionesAlternativas = [];
        
        // ... rest of the selection logic ...

        // Calculate KCl needed
        const kclMl = Math.round((potasioReq / 1.34) * 10) / 10;
        
        // Show in UI
        mostrarSolucionRecomendada(mejorOpcion, kclMl, potasioReq, condiciones);
        
        return { solucionOptima: mejorOpcion, solucionesAlternativas };
      } catch (error) {
        console.error("Error calculating recommended solution:", error);
        // Show error to user
        alert("Ocurrió un error al calcular la solución recomendada. Por favor intente nuevamente.");
        return { solucionOptima: null, solucionesAlternativas: [] };
      }
    }

    // Enhanced initialization with better event listeners
    document.addEventListener("DOMContentLoaded", () => {
      updateSolutionSelectorUI();
      
      // Improved input validation
      document.getElementById("peso").addEventListener("input", function() {
        const validation = validateWeight(parseFloat(this.value));
        if (!validation.valid && this.value) {
          showError(this, validation.message);
        } else {
          clearError(this);
        }
        document.getElementById("btnCalcular").disabled = !validation.valid;
      });

      document.getElementById("edad").addEventListener("input", function() {
        const validation = validateAge(parseFloat(this.value));
        if (!validation.valid && this.value) {
          showError(this, validation.message);
        } else {
          clearError(this);
        }
      });

      // Add ARIA attributes for better accessibility
      document.querySelectorAll('[id^="temp"]').forEach(input => {
        input.setAttribute('aria-describedby', `${input.id}-label`);
      });

      // Enhanced offline status detection
      updateOnlineStatus();
      window.addEventListener('online', () => {
        updateOnlineStatus();
        // Optional: Show a "back online" message
        const onlineStatus = document.createElement('div');
        onlineStatus.className = 'fixed bottom-0 left-0 right-0 bg-green-500 text-white p-2 text-center';
        onlineStatus.textContent = 'Conexión restablecida. Los datos se han sincronizado.';
        document.body.appendChild(onlineStatus);
        setTimeout(() => onlineStatus.remove(), 3000);
      });
      window.addEventListener('offline', updateOnlineStatus);
    });

    // ... rest of the existing functions remain the same ...
  </script>
</body>
</html>

// Funciones agregadas
function obtenerCondicionesSeleccionadas() {
  const checkboxes = document.querySelectorAll('input[name="condicionClinica"]:checked');
  return Array.from(checkboxes).map(cb => cb.value);
}

function mostrarFormulaHollidaySegar(pesoKg, mantenimiento, sodio, potasio, glucosa) {
  const output = \`
    <p><strong>Requerimientos según Holliday-Segar:</strong></p>
    <ul class="list-disc ml-5">
      <li>Agua: \${Math.round(mantenimiento)} ml/24h</li>
      <li>Sodio: \${sodio.toFixed(1)} mEq</li>
      <li>Potasio: \${potasio.toFixed(1)} mEq</li>
      <li>Glucosa: \${glucosa.toFixed(1)} g</li>
    </ul>
  \`;
  document.getElementById("hollidaySegarResult").innerHTML = output;
}

function mostrarNotasClinicas(solucion, condiciones, edad) {
  const notas = [];
  if (condiciones.includes("hiponatremia")) notas.push("⚠️ Considerar corrección lenta de hiponatremia.");
  if (condiciones.includes("hipernatremia")) notas.push("⚠️ Reducción de sodio para evitar sobrecorrección.");
  if (edad < 1) notas.push("👶 Requiere mayor vigilancia en menores de 1 año.");
  const result = \`
    <p><strong>Notas clínicas:</strong></p>
    <ul class="list-disc ml-5">\${notas.map(n => \`<li>\${n}</li>\`).join("")}</ul>
  \`;
  document.getElementById("notasClinicas").innerHTML = result;
}

function mostrarSolucionRecomendada(solucion, kclMl, potasioReq, condiciones) {
  const resultado = \`
    <p><strong>Solución Recomendada:</strong> \${solucion.nombre}</p>
    <p>\${solucion.descripcion}</p>
    <p>KCl: \${kclMl} ml (≈ \${potasioReq.toFixed(1)} mEq)</p>
  \`;
  document.getElementById("solucionRecomendada").innerHTML = resultado;
}

function mostrarSolucionesAlternativas(soluciones, potasioReq) {
  const lista = soluciones.map(sol => \`
    <li>
      <strong>\${sol.nombre}</strong> - Na: \${sol.naPorLitro} mEq/L, Glucosa: \${sol.glucosaPorLitro} g/L<br/>
      Volumen: \${sol.volumen} ml, KCl: \${(potasioReq / 1.34 * 10).toFixed(1)} ml
    </li>
  \`).join("");
  document.getElementById("listaAlternativas").innerHTML = \`<ul class="list-disc ml-5">\${lista}</ul>\`;
}

function updateSolutionSelectorUI() {
  console.log("Interfaz de selección de soluciones actualizada");
}

function updateOnlineStatus() {
  const statusElement = document.getElementById("estadoConexion");
  if (!statusElement) return;
  const online = navigator.onLine;
  statusElement.textContent = online ? "🟢 Conectado" : "🔴 Sin conexión";
  statusElement.className = online ? "text-green-600" : "text-red-600";
}
  </script>
</body>
</html>
