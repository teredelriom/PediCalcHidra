<!DOCTYPE html>
<html lang="es">
<head>
  <!-- ... (previous head content remains the same) ... -->
</head>
<body class="p-4 md:p-8">
  <!-- ... (previous body content remains the same until the script section) ... -->

  <script>
    // Constants for validation
    const MAX_WEIGHT = 50000; // 50kg in grams
    const MAX_AGE = 18; // Maximum age in years
    const MIN_TEMP = 35;
    const MAX_TEMP = 42;
    const MIN_AMBIENT_TEMP = 20;
    const MAX_AMBIENT_TEMP = 50;

    // Register Service Worker with improved error handling
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', async () => {
        try {
          const registration = await navigator.serviceWorker.register('sw.js');
          console.log('ServiceWorker registration successful with scope: ', registration.scope);
          
          // Check for updates
          registration.addEventListener('updatefound', () => {
            const newWorker = registration.installing;
            newWorker.addEventListener('statechange', () => {
              if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                console.log('New content available; please refresh.');
              }
            });
          });
        } catch (err) {
          console.error('ServiceWorker registration failed: ', err);
        }
      });
    }

    // Improved input validation functions
    function validateWeight(weight) {
      if (!weight || isNaN(weight)) {
        return { valid: false, message: "Por favor ingrese un peso válido" };
      }
      if (weight < 100) {
        return { valid: false, message: "El peso mínimo es 100g" };
      }
      if (weight > MAX_WEIGHT) {
        return { valid: false, message: `El peso máximo es ${MAX_WEIGHT/1000}kg` };
      }
      return { valid: true };
    }

    function validateAge(age) {
      if (age && (isNaN(age) || age < 0)) {
        return { valid: false, message: "Por favor ingrese una edad válida" };
      }
      if (age > MAX_AGE) {
        return { valid: false, message: `La edad máxima es ${MAX_AGE} años` };
      }
      return { valid: true };
    }

    function validateTemperature(temp, isBodyTemp = true) {
      if (!temp || isNaN(temp)) return { valid: false };
      
      const min = isBodyTemp ? MIN_TEMP : MIN_AMBIENT_TEMP;
      const max = isBodyTemp ? MAX_TEMP : MAX_AMBIENT_TEMP;
      
      if (temp < min || temp > max) {
        return { 
          valid: false,
          message: `La temperatura debe estar entre ${min}°C y ${max}°C`
        };
      }
      return { valid: true };
    }

    // Improved error display function
    function showError(inputElement, message) {
      const errorElement = document.createElement('p');
      errorElement.className = 'text-red-500 text-xs mt-1';
      errorElement.id = `${inputElement.id}-error`;
      errorElement.textContent = message;
      
      // Remove existing error if present
      const existingError = document.getElementById(`${inputElement.id}-error`);
      if (existingError) existingError.remove();
      
      inputElement.classList.add('border-red-500');
      inputElement.parentNode.appendChild(errorElement);
    }

    function clearError(inputElement) {
      inputElement.classList.remove('border-red-500');
      const errorElement = document.getElementById(`${inputElement.id}-error`);
      if (errorElement) errorElement.remove();
    }

    // Enhanced calcular function with better validation
    function calcular() {
      // Clear previous errors
      document.querySelectorAll('.input-highlight').forEach(input => clearError(input));
      
      // Validate inputs
      const pesoInput = document.getElementById("peso");
      const peso = parseFloat(pesoInput.value);
      const pesoValidation = validateWeight(peso);
      if (!pesoValidation.valid) {
        showError(pesoInput, pesoValidation.message);
        return;
      }

      const edadInput = document.getElementById("edad");
      const edad = parseFloat(edadInput.value) || 0;
      const edadValidation = validateAge(edad);
      if (!edadValidation.valid) {
        showError(edadInput, edadValidation.message);
        return;
      }

      // Validate temperatures if visible
      if (!document.getElementById("tempFiebre").classList.contains("hidden")) {
        const tempF = parseFloat(document.getElementById("tempF").value);
        const tempFValidation = validateTemperature(tempF);
        if (!tempFValidation.valid) {
          showError(document.getElementById("tempF"), tempFValidation.message);
          return;
        }
      }

      if (!document.getElementById("tempAmbiente").classList.contains("hidden")) {
        const tempA = parseFloat(document.getElementById("tempA").value);
        const tempAValidation = validateTemperature(tempA, false);
        if (!tempAValidation.valid) {
          showError(document.getElementById("tempA"), tempAValidation.message);
          return;
        }
      }

      // Rest of the calculation logic remains the same...
      const pesoKg = peso / 1000;
      const deficitPct = parseFloat(document.getElementById("deshidratacion").value);
      
      let mantenimiento = calcularMantenimiento(pesoKg);
      const deficit = pesoKg * deficitPct;
      const total24h = mantenimiento + deficit;
      
      // Update UI with results
      document.getElementById("mantenimientoResult").textContent = Math.round(mantenimiento);
      document.getElementById("deficitResult").textContent = Math.round(deficit);
      document.getElementById("total24hResult").textContent = Math.round(total24h);
      document.getElementById("flujoHorarioResult").textContent = (total24h / 24).toFixed(1);
      
      // Calculate electrolytes with improved validation
      const calorias = mantenimiento;
      const glucosaReq = calorias * 0.05;
      let sodioReq = calorias * 0.03;
      let potasioReq = calorias * 0.025;
      
      // Adjust based on conditions
      const condiciones = obtenerCondicionesSeleccionadas();
      if (condiciones.includes("hipernatremia")) sodioReq *= 0.5;
      if (condiciones.includes("hiponatremia")) sodioReq *= 1.5;
      if (condiciones.includes("edema") || condiciones.includes("oliguria")) potasioReq *= 0.5;
      
      // Calculate recommended solution
      const { solucionOptima, solucionesAlternativas } = calcularSolucionRecomendada(
        mantenimiento, 
        sodioReq, 
        potasioReq, 
        glucosaReq,
        condiciones,
        edad
      );
      
      // Show results
      mostrarFormulaHollidaySegar(pesoKg, mantenimiento, sodioReq, potasioReq, glucosaReq);
      mostrarNotasClinicas(solucionOptima, condiciones, edad);
      
      if (solucionesAlternativas.length > 0) {
        mostrarSolucionesAlternativas(solucionesAlternativas, potasioReq);
        document.getElementById("solucionesAlternativas").classList.remove("hidden");
      }
      
      document.getElementById("resultado").classList.remove("hidden");
      
      // Improve accessibility for screen readers
      const resultadoSection = document.getElementById("resultado");
      resultadoSection.setAttribute("aria-live", "polite");
      resultadoSection.setAttribute("aria-atomic", "true");
    }

    // Enhanced solution calculation with better error handling
    function calcularSolucionRecomendada(mantenimiento, sodioReq, potasioReq, glucosaReq, condiciones, edad) {
      try {
        // Load solutions from a more maintainable structure
        const solucionesBase = [
          { 
            nombre: "SG 5% + NaCl 0.2%",
            descripcion: "Solución glucosada al 5% con NaCl 0.2%",
            sgPorcentaje: 5,
            naPorLitro: 34,
            glucosaPorLitro: 50,
            caloriasPorLitro: 200,
            tipo: "bajaNa"
          },
          // ... other solutions ...
        ];

        // Evaluate each solution with volume constraints
        const opciones = solucionesBase.map(sol => {
          const volumen = Math.min(mantenimiento, (glucosaReq * 1000) / sol.glucosaPorLitro);
          const sodioTotal = (sol.naPorLitro * volumen) / 1000;
          const diferenciaSodio = sodioTotal - sodioReq;
          
          return {
            ...sol,
            volumen: Math.round(volumen),
            sodioTotal: parseFloat(sodioTotal.toFixed(1)),
            diferenciaSodio: parseFloat(diferenciaSodio.toFixed(1)),
            adecuacion: Math.abs(diferenciaSodio)
          };
        });

        // Select best option based on conditions
        let mejorOpcion = opciones[0];
        let solucionesAlternativas = [];
        
        // ... rest of the selection logic ...

        // Calculate KCl needed
        const kclMl = Math.round((potasioReq / 1.34) * 10) / 10;
        
        // Show in UI
        mostrarSolucionRecomendada(mejorOpcion, kclMl, potasioReq, condiciones);
        
        return { solucionOptima: mejorOpcion, solucionesAlternativas };
      } catch (error) {
        console.error("Error calculating recommended solution:", error);
        // Show error to user
        alert("Ocurrió un error al calcular la solución recomendada. Por favor intente nuevamente.");
        return { solucionOptima: null, solucionesAlternativas: [] };
      }
    }

    // Enhanced initialization with better event listeners
    document.addEventListener("DOMContentLoaded", () => {
      updateSolutionSelectorUI();
      
      // Improved input validation
      document.getElementById("peso").addEventListener("input", function() {
        const validation = validateWeight(parseFloat(this.value));
        if (!validation.valid && this.value) {
          showError(this, validation.message);
        } else {
          clearError(this);
        }
        document.getElementById("btnCalcular").disabled = !validation.valid;
      });

      document.getElementById("edad").addEventListener("input", function() {
        const validation = validateAge(parseFloat(this.value));
        if (!validation.valid && this.value) {
          showError(this, validation.message);
        } else {
          clearError(this);
        }
      });

      // Add ARIA attributes for better accessibility
      document.querySelectorAll('[id^="temp"]').forEach(input => {
        input.setAttribute('aria-describedby', `${input.id}-label`);
      });

      // Enhanced offline status detection
      updateOnlineStatus();
      window.addEventListener('online', () => {
        updateOnlineStatus();
        // Optional: Show a "back online" message
        const onlineStatus = document.createElement('div');
        onlineStatus.className = 'fixed bottom-0 left-0 right-0 bg-green-500 text-white p-2 text-center';
        onlineStatus.textContent = 'Conexión restablecida. Los datos se han sincronizado.';
        document.body.appendChild(onlineStatus);
        setTimeout(() => onlineStatus.remove(), 3000);
      });
      window.addEventListener('offline', updateOnlineStatus);
    });

    // ... rest of the existing functions remain the same ...
  </script>
</body>
</html>
